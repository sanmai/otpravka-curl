#!/bin/bash
set -e -u

test -f tkn.txt
test -f auth.txt

TKN="$(cat tkn.txt)"
AUTH="$(cat auth.txt)"
API=https://otpravka-api.pochta.ru

data=$(</dev/stdin)

jq=$(command -v jq || command -v json-tool || command -v cat)

verb=${1:-POST}
target="$2"

if [ -t 1 ]
then
    filter=$jq
    echo $data | $jq
    echo "$verb $target"
	echo
else
    filter=cat
fi

curl -s --dump-header /dev/stderr \
-H "X-User-Authorization: Basic $AUTH" \
-H "Authorization: AccessToken $TKN" \
-H "Content-Type: application/json;charset=UTF-8" \
-H "Accept: application/json;charset=UTF-8" \
--request $verb \
--data "$data" \
$API$target | $filter
